generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String    @map("password_hash")
  name                String
  targetWakeTime      String?   @map("target_wake_time") // HH:MM format
  onboardingCompleted Boolean   @default(false) @map("onboarding_completed")
  therapyStartDate    DateTime? @map("therapy_start_date") @db.Date
  baselineComplete    Boolean   @default(false) @map("baseline_complete")
  flaggedForReview    Boolean   @default(false) @map("flagged_for_review")
  flaggedReason       String?   @map("flagged_reason")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  isiAssessments    ISIAssessment[]
  sleepDiaries      SleepDiary[]
  sleepWindows      SleepWindow[]
  whoopConnection   WhoopConnection?
  whoopSleepRecords WhoopSleepRecord[]
  refreshTokens     RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model ISIAssessment {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  score       Int // 0-28
  responses   Json // Array of 7 question responses
  completedAt DateTime @default(now()) @map("completed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("isi_assessments")
}

enum DiarySource {
  MANUAL
  WHOOP
  HYBRID
}

enum Mood {
  VERY_POOR
  POOR
  OKAY
  GOOD
  GREAT
}

model SleepDiary {
  id                      String      @id @default(uuid())
  userId                  String      @map("user_id")
  date                    DateTime    @db.Date
  bedtime                 DateTime    // when user got into bed
  sleepOnsetLatencyMins   Int         @map("sleep_onset_latency_mins") // time to fall asleep
  numberOfAwakenings      Int         @map("number_of_awakenings")
  wakeAfterSleepOnsetMins Int         @map("wake_after_sleep_onset_mins") // WASO
  finalWakeTime           DateTime    @map("final_wake_time")
  outOfBedTime            DateTime    @map("out_of_bed_time")
  subjectiveQuality       Int         @map("subjective_quality") // 1-10
  totalSleepTimeMins      Int         @map("total_sleep_time_mins") // calculated
  timeInBedMins           Int         @map("time_in_bed_mins") // calculated
  sleepEfficiency         Decimal     @map("sleep_efficiency") @db.Decimal(5, 2) // calculated: TST/TIB * 100
  source                  DiarySource @default(MANUAL) // manual | whoop | hybrid
  whoopSleepRecordId      String?     @map("whoop_sleep_record_id") // link to WHOOP record if pre-filled
  notes                   String?
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("sleep_diaries")
}

enum WindowAdjustment {
  INCREASE
  DECREASE
  NONE
  BASELINE
}

model SleepWindow {
  id                 String            @id @default(uuid())
  userId             String            @map("user_id")
  weekStartDate      DateTime          @map("week_start_date") @db.Date
  prescribedBedtime  String            @map("prescribed_bedtime") // "23:30" format
  prescribedWakeTime String            @map("prescribed_wake_time") // "06:30" format
  timeInBedMins      Int               @map("time_in_bed_mins")
  avgSleepEfficiency Decimal?          @map("avg_sleep_efficiency") @db.Decimal(5, 2)
  adjustmentMade     WindowAdjustment? @map("adjustment_made") // increase | decrease | maintain | baseline
  adjustmentMins     Int               @default(0) @map("adjustment_mins")
  feedbackMessage    String?           @map("feedback_message") // warm motivational message
  createdAt          DateTime          @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate])
  @@map("sleep_windows")
}

model WhoopConnection {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  whoopUserId    String    @map("whoop_user_id")
  accessToken    String    @map("access_token") // Encrypted
  refreshToken   String    @map("refresh_token") // Encrypted
  tokenExpiresAt DateTime  @map("token_expires_at")
  connectedAt    DateTime  @default(now()) @map("connected_at")
  lastSyncedAt   DateTime? @map("last_synced_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("whoop_connections")
}

model WhoopSleepRecord {
  id                   String   @id @default(uuid())
  userId               String   @map("user_id")
  whoopSleepId         BigInt   @unique @map("whoop_sleep_id")
  startTime            DateTime @map("start_time")
  endTime              DateTime @map("end_time")
  totalSleepDurationMs BigInt   @map("total_sleep_duration_ms")
  remSleepMs           BigInt   @map("rem_sleep_ms")
  lightSleepMs         BigInt   @map("light_sleep_ms")
  deepSleepMs          BigInt   @map("deep_sleep_ms")
  awakeDurationMs      BigInt   @map("awake_duration_ms")
  sleepEfficiency      Decimal  @map("sleep_efficiency") @db.Decimal(5, 2)
  recoveryScore        Int?     @map("recovery_score")
  hrvRmssd             Decimal? @map("hrv_rmssd") @db.Decimal(6, 2)
  restingHeartRate     Int?     @map("resting_heart_rate")
  rawJson              Json     @map("raw_json")
  createdAt            DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("whoop_sleep_records")
}
